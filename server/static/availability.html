<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Room Availability (Gantt Chart)</title>

<!-- moment + timezone (MUST BE INCLUDED BEFORE timeline init) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
<script>
    // Set default timezone to America/New_York so all moment() uses EST
    moment.tz.setDefault("America/New_York");
</script>

<!-- vis-timeline -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/styles/vis-timeline-graph2d.min.css">
<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/standalone/umd/vis-timeline-graph2d.min.js"></script>
<style>
    body {
        background: #f4f4f8;
        font-family: Arial, sans-serif;
    }

    .chart-container {
        width: 95%;
        margin: 30px auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    #timeline {
        height: 700px;
        border-radius: 8px;
    }

    .book-btn {
        display: block;
        margin: 10px auto;
        padding: 12px 25px;
        background: #007bff;
        color: white;
        border-radius: 8px;
        width: 200px;
        font-size: 18px;
        text-align: center;
        text-decoration: none;
    }

    .book-btn:hover {
        background: #0056b3;
    }
</style>
</head>

<body>

<div class="chart-container">
    <a href="https://umich.libcal.com/spaces?lid=2761&gid=5040"
       class="book-btn" target="_blank">Let's Book</a>

    <h2 style="text-align:center; margin-top:10px;">
        Room Availability Timeline
    </h2>

    <div id="timeline"></div>
</div>

<script>
/* ---------------------------------------------------------------
   强制 timeline 所有时间格式化使用 America/New_York（EST）
-----------------------------------------------------------------*/
function est(date) {
    return moment(date).tz("America/New_York");
}

/* ---------------------------------------------------------------
   Parse LibCal time string → JS Date (EST)
-----------------------------------------------------------------*/
function parseEST(str) {
    try {
        let left = str.split(" - ")[0];
        let firstSpace = left.indexOf(" ");

        let timePart = left.substring(0, firstSpace)
            .replace(/am/i, " AM")
            .replace(/pm/i, " PM");

        let datePart = left.substring(firstSpace + 1)
            .replace(/^\w+, /, ""); // remove weekday

        let full = `${datePart} ${timePart}`;

        // Use format with space-before-AM/PM and uppercase A
        return moment.tz(full, "MMMM D, YYYY h:mm A", "America/New_York").toDate();
    } catch (e) {
        return null;
    }
}

/* ---------------------------------------------------------------
   Load record.json
-----------------------------------------------------------------*/
async function loadRecord() {
    let r = await fetch("/record.json");
    return await r.json();
}

/* ---------------------------------------------------------------
   Build the Gantt Chart
-----------------------------------------------------------------*/
async function draw() {
    let data = await loadRecord();
    let now = moment().tz("America/New_York");

    let items = [];
    let roomSet = new Set();
    let idCounter = 1;

    data.forEach(entry => {
        if (entry.status !== "Available") return;

        let start = parseEST(entry.time);
        if (!start) return;

        let mStart = moment(start).tz("America/New_York");
        if (mStart.isBefore(now)) return;

        let mEnd = mStart.clone().add(30, "minutes");

        roomSet.add(entry.Name);

        items.push({
            id: idCounter++,
            group: entry.Name,
            // use ISO strings with timezone offset so timeline parses them in EST
            start: mStart.toISOString(true),
            end: mEnd.toISOString(true),
            content: "",
            style: "background-color:#4caf50; border:none; border-radius:4px;"
        });
    });

    let groups = [...roomSet].sort().map(name => ({
        id: name,
        content: name
    }));

    let container = document.getElementById("timeline");

     /* ---------------------------------------------------------------
         档位最关键：强制 vis-timeline 按 EST 显示刻度
         并且将初始可见窗口固定为 EST 当天，防止 timeline 在加载 items 后 auto-fit
     ---------------------------------------------------------------*/

     // compute EST day window
     let startWindow = now.clone().startOf('day');
     let endWindow = startWindow.clone().add(1, 'day');

     const options = {
          // initial visible window (use Date objects)
          start: startWindow.toDate(),
          end: endWindow.toDate(),
        stack: false,
        horizontalScroll: true,
        zoomKey: "ctrlKey",
        zoomMin: 15 * 60 * 1000,
        zoomMax: 12 * 60 * 60 * 1000,
        orientation: "top",
        margin: { item: 5 },

        /** ★★★ 关键：覆盖 vis 的 moment 格式化行为 ★★★ */
        moment: function (date) {
            return moment(date).tz("America/New_York");
        },

        /** ★★★ 关键：强制 x 轴刻度按 EST 输出 ★★★ */
        format: {
            minorLabels: {
                minute: "HH:mm",
                hour: "HH:mm",
                day: "HH:mm"
            },
            majorLabels: {
                day: "ddd D MMMM",
                week: "ddd D MMMM",
                month: "MMMM YYYY"
            }
        }
    };

    let timeline = new vis.Timeline(
        container,
        new vis.DataSet(items),
        new vis.DataSet(groups),
        options
    );

    // Force the visible window to today's EST day to ensure header shows EST date
    try {
        let startWindow = now.clone().startOf('day');
        let endWindow = startWindow.clone().add(1, 'day');
        // use Date objects to avoid ambiguous string parsing by timeline
        timeline.setWindow(startWindow.toDate(), endWindow.toDate());
    } catch (e) {
        console.warn('Failed to set timeline window explicitly:', e);
    }

    /* 方便调试 */
    console.log("Browser TZ:", Intl.DateTimeFormat().resolvedOptions());
    console.log("Timeline window:", timeline.getWindow());
}

draw();
</script>

</body>
</html>
